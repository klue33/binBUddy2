{% extends "base.html" %}
{% block content %}
    <h2>Manage Your Subscription</h2>
    
    {% if current_user.subscription_status == 'active' %}
        <p>You have an active subscription. Thank you!</p>
        <form action="{{ url_for('create_portal_session') }}" method="POST">
            <button type="submit">Manage Billing & Invoices</button>
        </form>
    {% elif current_user.subscription_status == 'trial' and (datetime.utcnow() < current_user.trial_end_date) %}
        <p>You are currently on a trial. It will end on {{ current_user.trial_end_date.strftime('%Y-%m-%d') }}.</p>
        <button id="subscribe-btn">Subscribe Now</button>
    {% else %}
        <p>Your trial has expired or you do not have a subscription.</p>
        <button id="subscribe-btn">Subscribe for $10/month</button>
    {% endif %}

    <!-- Include Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const subscribeBtn = document.getElementById('subscribe-btn');
        if (subscribeBtn) {
            subscribeBtn.addEventListener('click', async () => {
                const response = await fetch("{{ url_for('create_checkout_session') }}", { method: 'POST' });
                const session = await response.json();
                
                const stripe = Stripe("{{ config.STRIPE_PUBLISHABLE_KEY }}");
                stripe.redirectToCheckout({ sessionId: session.sessionId });
            });
        }
    </script>
{% endblock %}
