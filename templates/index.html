{% extends "base.html" %}
{% block content %}
<style>
    /* --- Styles for Core App UI --- */
    .hidden { display: none; }
    
    /* Upload Section */
    #upload-section { text-align: center; }
    #upload-form label {
        display: block; border: 2px dashed #555; padding: 2rem; border-radius: 10px;
        margin-bottom: 1rem; cursor: pointer;
    }
    #upload-form input[type="file"] { display: none; } /* Hide the default file input */
    #btn-take-photo { width: 100%; margin-bottom: 2rem; }

    .button-container { margin-top: 2rem; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
    .button-container p { margin: 0.25rem 0 0 0; color: #888; text-align: center; }
    .button-primary { background-color: var(--primary-color); color: white; width: 80%; padding: 1rem; }
    .button-secondary { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); width: 80%; padding: 1rem; }

    /* Results Section */
    #match-container { display: grid; gap: 1.5rem; margin-top: 2rem; }
    .match-card {
        border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem;
        background-color: var(--card-background-color); transition: all 0.2s ease-in-out;
    }
    .match-card.highlighted {
        border: 2px solid var(--primary-color); box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        transform: scale(1.02);
    }
    .match-card h3, .match-card h4 { margin-top: 0; }
    .match-card h4 { color: var(--primary-color); text-align: center; }

    .attributes-list { list-style-type: none; padding-left: 0; font-size: 0.9rem; }
    .attributes-list li { background-color: var(--background-color); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; }

    /* Cropping Modal */
    .modal-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: var(--background-color); padding: 2rem; border-radius: 10px;
        max-width: 90vw; max-height: 90vh; text-align: center;
    }
    .img-container { max-height: 60vh; margin: 1rem 0; }
    #image-to-crop { display: block; max-width: 100%; }
</style>

<!-- SECTION 1: UPLOAD -->
<section id="upload-section">
    <h2>Step 1: Select a Photo</h2>
    <form id="upload-form">
        <!-- The label now acts as the 'upload' button -->
        <label for="file-input">Drag & Drop or Click to Upload</label>
        <!-- The actual file input is hidden but triggered by the label and the 'Take Photo' button -->
        <input type="file" id="file-input" accept="image/*" capture="environment">
        
        <!-- A dedicated button for taking a photo on mobile -->
        <button type="button" id="btn-take-photo">Take Photo</button>
    </form>

    <!-- The two analysis choices, initially hidden -->
    <div id="action-buttons" class="button-container hidden">
        <p><strong>Photo Selected. Now, choose your goal:</strong></p>
        <div>
            <button id="btn-identify-primary" class="button-primary">Identify Primary Item</button>
            <p><small>Finds the single, most prominent object.</small></p>
        </div>
        <div>
            <button id="btn-scan-all" class="button-secondary">Scan for All Items & Rank by Value</button>
            <p><small>Detects multiple objects and sorts by price.</small></p>
        </div>
    </div>
    
    <div id="loading-indicator" class="hidden">
        <p>ðŸ”Ž Analyzing image with Vertex AI...</p>
    </div>
</section>

<!-- SECTION 2: CONFIRMATION -->
<section id="confirmation-section" class="hidden">
    <div id="match-container"></div>
</section>

<!-- SECTION 3: LISTING -->
<section id="listing-section" class="hidden">
    <!-- This section remains the same as before -->
</section>

<!-- CROPPING MODAL (Initially Hidden) -->
<div id="crop-modal" class="modal-container hidden">
    <div class="modal-content">
        <h3>Crop Your Image</h3>
        <p>Adjust the box to focus on the item you want to identify.</p>
        <div class="img-container">
            <img id="image-to-crop">
        </div>
        <button id="btn-crop-confirm">Crop & Confirm</button>
    </div>
</div>


<script>
    // --- STATE & DOM REFERENCES ---
    let productMatches = [];
    let confirmedProduct = {};
    let cropper = null;
    window.croppedImageBlob = null; // Use window scope to store the cropped image blob

    // DOM Elements
    const fileInput = document.getElementById('file-input');
    const btnTakePhoto = document.getElementById('btn-take-photo');
    const cropModal = document.getElementById('crop-modal');
    const imageToCrop = document.getElementById('image-to-crop');
    const btnCropConfirm = document.getElementById('btn-crop-confirm');
    const actionButtons = document.getElementById('action-buttons');
    const btnIdentifyPrimary = document.getElementById('btn-identify-primary');
    const btnScanAll = document.getElementById('btn-scan-all');
    // ... (other DOM element references)

    // --- EVENT LISTENERS ---

    // Trigger the hidden file input when the user clicks "Take Photo"
    btnTakePhoto.addEventListener('click', () => fileInput.click());

    // This is the main entry point: when a file is selected OR a photo is taken
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                cropModal.classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, { viewMode: 1, background: false, autoCropArea: 0.8 });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    // When the user confirms their crop
    btnCropConfirm.addEventListener('click', () => {
        if (!cropper) return;
        cropper.getCroppedCanvas({ width: 1024, height: 1024, imageSmoothingQuality: 'high' })
            .toBlob((blob) => {
                window.croppedImageBlob = blob; // Store the cropped image data
                cropModal.classList.add('hidden'); // Hide the cropper
                actionButtons.classList.remove('hidden'); // Show the two analysis buttons
            }, 'image/jpeg');
    });

    // Listeners for the two analysis buttons
    btnIdentifyPrimary.addEventListener('click', () => handleImageAnalysis('single'));
    btnScanAll.addEventListener('click', () => handleImageAnalysis('multi'));
    
    // ... (matchContainer click listener remains the same)

    // --- CORE FUNCTIONS ---

    /**
     * Main function to send the CROPPED image to the backend.
     */
    async function handleImageAnalysis(mode) {
        if (!window.croppedImageBlob) {
            alert("An image has not been cropped yet. Please upload and crop an image.");
            return;
        }
        const formData = new FormData();
        formData.append('file', window.croppedImageBlob, 'cropped.jpg');
        formData.append('mode', mode);

        // UI updates for loading state
        const loadingIndicator = document.getElementById('loading-indicator');
        const uploadSection = document.getElementById('upload-section');
        const uploadForm = document.getElementById('upload-form');
        loadingIndicator.classList.remove('hidden');
        actionButtons.classList.add('hidden');
        uploadForm.classList.add('hidden');
        btnTakePhoto.classList.add('hidden');


        try {
            const response = await fetch('/api/identify-item', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            
            productMatches = data.matches;
            renderMatches();

            uploadSection.classList.add('hidden');
            document.getElementById('confirmation-section').classList.remove('hidden');
        } catch (error) {
            console.error(`Error during '${mode}' analysis:`, error);
            alert("Could not analyze the image. Please try again.");
            // Reset UI on error
            uploadSection.classList.remove('hidden');
            uploadForm.classList.remove('hidden');
            btnTakePhoto.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Renders the match cards, adapting for single vs. multi-object results.
     */
    function renderMatches() {
        const matchContainer = document.getElementById('match-container');
        const isMultiMode = productMatches.length > 1;

        if (isMultiMode) {
            matchContainer.innerHTML = '<h3>Scan Results: ' + productMatches.length + ' Items Found (Ranked by Value)</h3>';
        } else if (productMatches.length === 1) {
            matchContainer.innerHTML = '<h3>Result for Primary Item</h3>';
        } else {
            matchContainer.innerHTML = '<h3>No confident matches found.</h3><p>Please try another photo or crop closer to the item.</p>';
            return;
        }

        productMatches.forEach((product, index) => {
            const isHighestValue = isMultiMode && index === 0;
            let attributesHtml = '<ul class="attributes-list">';
            let hasAttributes = false;
            if (product.attributes && typeof product.attributes === 'object') {
                for (const [key, value] of Object.entries(product.attributes)) {
                    if (value) {
                        attributesHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                        hasAttributes = true;
                    }
                }
            }
            attributesHtml += '</ul>';
            if (!hasAttributes) attributesHtml = '';

            matchContainer.innerHTML += `
                <article class="match-card ${isHighestValue ? 'highlighted' : ''}">
                    ${isHighestValue ? '<h4>â˜… #1 Highest Value â˜…</h4>' : ''}
                    <h3>${isMultiMode ? `#${index + 1}: ` : ''}${product.name}</h3>
                    <p><em>Brand: ${product.brand || 'Unknown'}</em></p>
                    ${!isMultiMode || isHighestValue ? `<p>${product.description || ''}</p>${attributesHtml}` : ''}
                    <div class="comps-grid">
                        <div><strong>Est. Value</strong><br>$${(product.comps.high || 0).toFixed(2)}</div>
                    </div>
                    <button class="confirm-btn" data-product-id="${product.id}">âœ… Select to Create Listing</button>
                </article>
            `;
        });
    }

    /**
     * Populates the final listing form.
     */
    function populateListingForm() {
        // This function logic remains unchanged
    }
</script>
{% endblock %}
