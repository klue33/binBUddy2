{% extends "base.html" %}
{% block content %}
<style>
    /* Styles specific to the core app UI */
    .hidden { display: none; }
    #match-container { display: grid; gap: 1.5rem; }
    .match-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
    .match-card h3 { margin-top: 0; }
    .comps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
</style>

<!-- SECTION 1: UPLOAD -->
<section id="upload-section">
    <h2>Step 1: Find Your Item</h2>
    <form id="upload-form">
        <label for="file-input">Upload Photo(s)</label>
        <input type="file" id="file-input" required>
        <button type="submit">Find My Item</button>
    </form>
    <div id="loading-indicator" class="hidden">
        <p>ðŸ”Ž Analyzing image and searching for matches...</p>
    </div>
</section>

<!-- SECTION 2: CONFIRMATION -->
<section id="confirmation-section" class="hidden">
    <h2>Step 2: Confirm a Match</h2>
    <div id="match-container"></div>
</section>

<!-- SECTION 3: LISTING -->
<section id="listing-section" class="hidden">
    <h2>Step 3: Listing Details</h2>
    <form id="listing-form">
        <label for="listing-title">Listing Title</label>
        <input type="text" id="listing-title" readonly>
        
        <label for="listing-description">Description</label>
        <textarea id="listing-description" rows="5"></textarea>
        
        <label for="listing-price">Set Your Price ($)</label>
        <input type="number" id="listing-price" step="0.01">
    </form>
</section>

<script>
    let productMatches = [];
    let confirmedProduct = {};

    const uploadSection = document.getElementById('upload-section');
    const confirmationSection = document.getElementById('confirmation-section');
    const listingSection = document.getElementById('listing-section');
    const uploadForm = document.getElementById('upload-form');
    const loadingIndicator = document.getElementById('loading-indicator');
    const matchContainer = document.getElementById('match-container');
    
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        const fileInput = document.getElementById('file-input');
        if (fileInput.files.length === 0) { alert("Please select a file."); return; }
        formData.append('file', fileInput.files[0]);

        loadingIndicator.classList.remove('hidden');
        uploadForm.style.display = 'none';

        try {
            const response = await fetch('/api/identify-item', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.error) { throw new Error(data.error); }

            productMatches = data.matches;
            renderMatches();

            uploadSection.classList.add('hidden');
            confirmationSection.classList.remove('hidden');
        } catch (error) {
            console.error("Error identifying item:", error);
            alert("Could not fetch item matches: " + error.message);
            uploadForm.style.display = 'block';
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    });

    matchContainer.addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('confirm-btn')) {
            const productId = e.target.dataset.productId;
            confirmedProduct = productMatches.find(p => p.id === productId);
            if (confirmedProduct) {
                populateListingForm();
                confirmationSection.classList.add('hidden');
                listingSection.classList.remove('hidden');
            }
        }
    });

    function renderMatches() {
        matchContainer.innerHTML = '<h3>We found the following items. Please select a match:</h3>';
        if (productMatches.length === 0) {
            matchContainer.innerHTML += '<p>No confident matches found. Please try another image.</p>';
        }
        productMatches.forEach(product => {
            matchContainer.innerHTML += `
                <article class="match-card">
                    <h3>${product.name}</h3>
                    <p>${product.description}</p>
                    <div class="comps-grid">
                        <div><strong>Retail</strong><br>$${product.comps.retail.toFixed(2)}</div>
                        <div><strong>High Comp</strong><br>$${product.comps.high.toFixed(2)}</div>
                    </div>
                    <button class="confirm-btn" data-product-id="${product.id}">âœ… This is it!</button>
                </article>
            `;
        });
    }

    function populateListingForm() {
        document.getElementById('listing-title').value = `For Sale: ${confirmedProduct.name}`;
        document.getElementById('listing-description').value = confirmedProduct.description;
        document.getElementById('listing-price').value = (confirmedProduct.comps.retail * 0.65).toFixed(2);
    }
</script>
{% endblock %}
