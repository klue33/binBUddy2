{% extends "base.html" %}
{% block content %}
<style>
    /* Styles specific to the core app UI */
    .hidden { display: none; }
    #match-container { display: grid; gap: 1.5rem; }
    .match-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
    .match-card h3 { margin-top: 0; }
    .comps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
</style>

<!-- SECTION 1: UPLOAD -->
<section id="upload-section">
    <style>
    .button-container { margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
    .button-container p { margin: 0; color: #888; text-align: center; }
    .button-primary { background-color: var(--primary-color); }
    .button-secondary { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
</style>
    <h2>Step 1: Find Your Item</h2>
    <form id="upload-form">
        <label for="file-input">Upload Photo(s)</label>
        <input type="file" id="file-input" required>
        <button type="submit">Find My Item</button>
    </form>
    <!-- Add this new container for the buttons -->
<div id="action-buttons" class="button-container hidden">
    <p>Now, choose your goal:</p>
    <div>
        <button id="btn-identify-primary" class="button-primary">Identify Primary Item</button>
        <p><small>Find the single, most prominent object in the photo.</small></p>
    </div>
    <div>
        <button id="btn-scan-all" class="button-secondary">Scan for All Items & Rank by Value</button>
        <p><small>Detects multiple objects and sorts them by price.</small></p>
    </div>
</div>
    <div id="loading-indicator" class="hidden">
        <p>ðŸ”Ž Analyzing image and searching for matches...</p>
    </div>
</section>

<!-- SECTION 2: CONFIRMATION -->
<section id="confirmation-section" class="hidden">
    <h2>Step 2: Confirm a Match</h2>
    <div id="match-container"></div>
</section>

<!-- SECTION 3: LISTING -->
<section id="listing-section" class="hidden">
    <h2>Step 3: Listing Details</h2>
    <form id="listing-form">
        <label for="listing-title">Listing Title</label>
        <input type="text" id="listing-title" readonly>
        
        <label for="listing-description">Description</label>
        <textarea id="listing-description" rows="5"></textarea>
        
        <label for="listing-price">Set Your Price ($)</label>
        <input type="number" id="listing-price" step="0.01">
    </form>
</section>
<script>
    // ... (keep existing variable declarations)

    const actionButtons = document.getElementById('action-buttons');
    const btnIdentifyPrimary = document.getElementById('btn-identify-primary');
    const btnScanAll = document.getElementById('btn-scan-all');
    const fileInput = document.getElementById('file-input');

    // Show the buttons after a file is selected
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            actionButtons.classList.remove('hidden');
        } else {
            actionButtons.classList.add('hidden');
        }
    });

    // Add event listeners for each button
    btnIdentifyPrimary.addEventListener('click', () => {
        handleImageAnalysis('single');
    });

    btnScanAll.addEventListener('click', () => {
        handleImageAnalysis('multi');
    });

    // This new function replaces your old 'submit' event listener
    async function handleImageAnalysis(mode) {
        if (fileInput.files.length === 0) {
            alert("Please select a file to upload.");
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('mode', mode); // <-- The crucial parameter

        loadingIndicator.classList.remove('hidden');
        actionButtons.classList.add('hidden');
        uploadForm.classList.add('hidden');

        try {
            const response = await fetch('/api/identify-item', { 
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.error) { throw new Error(data.error); }
            
            productMatches = data.matches;
            renderMatches(); // Your existing function to display results

            uploadSection.classList.add('hidden');
            confirmationSection.classList.remove('hidden');
        } catch (error) {
            console.error(`Error during '${mode}' analysis:`, error);
            alert("Could not analyze the image. Please try again.");
            uploadSection.classList.remove('hidden');
            uploadForm.classList.remove('hidden');
            actionButtons.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }
</script>
<script>
    let productMatches = [];
    let confirmedProduct = {};

    const uploadSection = document.getElementById('upload-section');
    const confirmationSection = document.getElementById('confirmation-section');
    const listingSection = document.getElementById('listing-section');
    const uploadForm = document.getElementById('upload-form');
    const loadingIndicator = document.getElementById('loading-indicator');
    const matchContainer = document.getElementById('match-container');
    
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        const fileInput = document.getElementById('file-input');
        if (fileInput.files.length === 0) { alert("Please select a file."); return; }
        formData.append('file', fileInput.files[0]);

        loadingIndicator.classList.remove('hidden');
        uploadForm.style.display = 'none';

        try {
            const response = await fetch('/api/identify-item', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.error) { throw new Error(data.error); }

            productMatches = data.matches;
            renderMatches();

            uploadSection.classList.add('hidden');
            confirmationSection.classList.remove('hidden');
        } catch (error) {
            console.error("Error identifying item:", error);
            alert("Could not fetch item matches: " + error.message);
            uploadForm.style.display = 'block';
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    });

    matchContainer.addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('confirm-btn')) {
            const productId = e.target.dataset.productId;
            confirmedProduct = productMatches.find(p => p.id === productId);
            if (confirmedProduct) {
                populateListingForm();
                confirmationSection.classList.add('hidden');
                listingSection.classList.remove('hidden');
            }
        }
    });

    function renderMatches() {
        matchContainer.innerHTML = '<h3>We found the following items. Please select a match:</h3>';
        if (productMatches.length === 0) {
            matchContainer.innerHTML += '<p>No confident matches found. Please try another image.</p>';
        }
        productMatches.forEach(product => {
            matchContainer.innerHTML += `
                <article class="match-card">
                    <h3>${product.name}</h3>
                    <p>${product.description}</p>
                    <div class="comps-grid">
                        <div><strong>Retail</strong><br>$${product.comps.retail.toFixed(2)}</div>
                        <div><strong>High Comp</strong><br>$${product.comps.high.toFixed(2)}</div>
                    </div>
                    <button class="confirm-btn" data-product-id="${product.id}">âœ… This is it!</button>
                </article>
            `;
        });
    }

    function populateListingForm() {
        document.getElementById('listing-title').value = `For Sale: ${confirmedProduct.name}`;
        document.getElementById('listing-description').value = confirmedProduct.description;
        document.getElementById('listing-price').value = (confirmedProduct.comps.retail * 0.65).toFixed(2);
    }
</script>
{% endblock %}
